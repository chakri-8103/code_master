<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Code Master Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
    }

    .question-card {
      margin-bottom: 20px;
    }

    .form-title {
      text-align: center;
      margin-bottom: 30px;
    }

    .submit-btn {
      text-align: center;
      margin-top: 20px;
    }

    .result-card {
      margin-top: 30px;
    }

    #videoPreview {
      width: 100%;
      max-width: 300px;
      height: 220px;
      border: 2px solid #ccc;
      border-radius: 10px;
      margin: 10px auto;
      display: block;
      position: sticky;
      top: 10px;
      z-index: 10;
    }

    .completed-item {
      cursor: pointer;
    }

    .completed-item:hover {
      background: #e9ecef;
    }

    #questionsWrapper {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }

    /* Darker radio buttons */
    .form-check-input {
      accent-color: #343a40;
      width: 1.2em;
      height: 1.2em;
      margin-top: 0.3em;
    }

    .form-check-label {
      margin-left: 0.3em;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <div class="form-title">
      <h2 class="fw-bold">Code Master - Online Exam</h2>
      <p class="text-muted">Answer all questions carefully</p>
    </div>

    <!-- Student Info Form -->
    <form id="infoForm" autocomplete="off">
      <div class="card mb-3 p-3"><label class="form-label fw-bold">Full Name</label><input type="text"
          class="form-control" id="fullName" readonly></div>
      <div class="card mb-3 p-3"><label class="form-label fw-bold">Succode</label><input type="text"
          class="form-control" id="succode" readonly></div>
      <div class="card mb-3 p-3"><label class="form-label fw-bold">College</label><input type="text"
          class="form-control" id="college" readonly></div>
      <div class="card mb-3 p-3"><label class="form-label fw-bold">Mobile Number</label><input type="text"
          class="form-control" id="mobile" readonly></div>
      <div class="card mb-3 p-3"><label class="form-label fw-bold">Email</label><input type="email" class="form-control"
          id="email" readonly></div>
      <div class="card mb-3 p-3"><label class="form-label fw-bold">Year</label><input type="text" class="form-control"
          id="year" readonly></div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Select Company</label>
        <select id="companySelect" class="form-select" required>
          <option value="">-- Choose Company --</option>
        </select>
      </div>
      <div class="submit-btn"><button type="submit" class="btn btn-primary btn-lg">Start Exam</button></div>
      <div id="completedList" class="mt-4"></div>
    </form>

    <!-- Exam Form -->
    <form id="examForm" class="d-none" autocomplete="off">
      <div class="row">
        <div class="col-md-4 text-center"><video id="videoPreview" autoplay muted></video></div>
        <div class="col-md-8">
          <div id="questionsWrapper">
            <div id="questionsArea"></div>
          </div>
          <div class="submit-btn"><button type="submit" class="btn btn-success btn-lg">Submit Exam</button></div>
        </div>
      </div>
    </form>

    <!-- Result Area -->
    <div id="resultArea" class="result-card d-none">
      <div class="card p-4 shadow-sm">
        <h4 class="fw-bold">Exam Result</h4>
        <p class="mb-1"><b>Full Name:</b> <span id="resName"></span></p>
        <p class="mb-1"><b>Succode:</b> <span id="resSuccode"></span></p>
        <p class="mb-1"><b>College:</b> <span id="resCollege"></span></p>
        <p class="mb-1"><b>Mobile:</b> <span id="resMobile"></span></p>
        <p class="mb-1"><b>Email:</b> <span id="resEmail"></span></p>
        <p class="mb-1"><b>Company:</b> <span id="resCompany"></span></p>
        <p class="mb-1"><b>Marks:</b> <span id="resMarks"></span></p>
        <p class="mb-1"><b>Status:</b> <span id="resStatus"></span></p>
        <p class="text-danger" id="resReason" style="display:none;"></p>
        <h5 class="mt-3">Explanations:</h5>
        <div id="resExplanations"></div>
        <div class="text-center mt-3"><button id="homeBtn" class="btn btn-secondary">üè† Home</button></div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
    <div id="submitToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive"
      aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMessage">Video submitted successfully!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    console.log("Exam page loaded");

    document.addEventListener("contextmenu", e => e.preventDefault());
    ["copy", "paste", "cut"].forEach(evt => document.addEventListener(evt, e => e.preventDefault()));
    document.addEventListener("keydown", e => {
      const blockedCtrl = ["u", "U", "c", "C", "v", "V", "x", "X", "s", "S"];
      if (e.key === "F12" || e.key === "PrintScreen" || (e.ctrlKey && blockedCtrl.includes(e.key)) || (e.ctrlKey && e.shiftKey && (e.key === "i" || e.key === "I"))) { e.preventDefault(); alert("‚ö†Ô∏è This action is disabled during the exam!"); }
    });

    let questionsData = {}, submitted = false, mediaRecorder, recordedChunks = [], student = { fullName: "", succode: "", college: "", mobile: "", email: "", company: "" };
    const companies = ["WIPRO"];

    function loadStudentInfo() {
      const studentData = {
        fullName: localStorage.getItem("name"),
        succode: localStorage.getItem("succode"),
        college: localStorage.getItem("college"),
        mobile: localStorage.getItem("mobile"),
        email: localStorage.getItem("email"),
        year: localStorage.getItem("year")
      };
      Object.keys(studentData).forEach(k => { if (studentData[k]) document.getElementById(k === "fullName" ? "fullName" : k).value = studentData[k]; });
    }
    loadStudentInfo();

    function saveResult(data) { let results = JSON.parse(localStorage.getItem("examResults") || "[]"); results = results.filter(r => r.company !== data.company); results.push(data); localStorage.setItem("examResults", JSON.stringify(results)); }
    function getResult(company) { return JSON.parse(localStorage.getItem("examResults") || "[]").find(r => r.company === company); }
    function saveCompletedCompany(company) { let completed = JSON.parse(localStorage.getItem("completedCompanies") || "[]"); if (!completed.includes(company)) { completed.push(company); localStorage.setItem("completedCompanies", JSON.stringify(completed)); } }
    function markCompletedCompanies() { let completed = JSON.parse(localStorage.getItem("completedCompanies") || "[]"); const listDiv = document.getElementById("completedList"); if (completed.length > 0) { listDiv.innerHTML = "<h6>‚úÖ Completed Tests</h6><ul class='list-group'>" + completed.map(c => `<li class="list-group-item completed-item" data-company="${c}">${c} ‚úÖ</li>`).join("") + "</ul>"; document.querySelectorAll(".completed-item").forEach(item => { item.addEventListener("click", () => { const comp = item.getAttribute("data-company"); const res = getResult(comp); if (res) showResult(res, false); }); }); } else listDiv.innerHTML = ""; const companySelect = document.getElementById("companySelect");[...companySelect.options].forEach(opt => { if (completed.includes(opt.value)) opt.remove(); }); }

    async function loadQuestions() {
      try {
        const response = await fetch("question.txt");
        const text = await response.text();
        const lines = text.split("\n").map(l => l.trim());
        let currentCompany = "", qObj = null;
        lines.forEach(line => {
          if (!line) return;
          if (companies.includes(line)) { currentCompany = line; if (!questionsData[currentCompany]) questionsData[currentCompany] = []; qObj = null; return; }
          if (line.startsWith("Q")) { qObj = { question: line, options: [], answer: "", explanation: "" }; questionsData[currentCompany].push(qObj); return; }
          if (qObj && !line.startsWith("Answer:") && !line.startsWith("Explanation:")) qObj.options.push(line);
          if (line.startsWith("Answer:")) qObj.answer = line.replace("Answer:", "").trim();
          if (line.startsWith("Explanation:")) qObj.explanation = line.replace("Explanation:", "").trim();
        });
      } catch (e) { console.warn("question.txt failed to load:", e); }
      const companySelect = document.getElementById("companySelect");
      companies.forEach(company => { const opt = document.createElement("option"); opt.value = company; opt.textContent = company; companySelect.appendChild(opt); });
    }

    function renderQuestions(company) {
      const questionsArea = document.getElementById("questionsArea");
      questionsArea.innerHTML = "";
      if (!company || !questionsData[company] || questionsData[company].length === 0) { questionsArea.innerHTML = `<div class="alert alert-warning">No questions available for ${company}. Updated Soon.</div>`; return; }
      questionsData[company].forEach((q, index) => {
        const card = document.createElement("div"); card.className = "card question-card p-3 shadow-sm";
        let html = `<h5 class="fw-bold mb-2">${q.question}</h5>`;
        q.options.forEach(opt => {
          // Check if the option is a heading
          if (/^(Options:|Conclusions:|Statement:|Input:|Output:|Given:)/i.test(opt)) {
            html += `<p class="fw-bold mb-1">${opt}</p>`;
          }
          // Check if it is an actual option under "Options:"
          else if (/^a\)|b\)|c\)|d\)/i.test(opt.trim())) {
            html += `<div class="form-check mb-1">
               <input class="form-check-input" type="radio" name="q${index}" value="${opt}" required>
               <label class="form-check-label">${opt}</label>
             </div>`;
          }
          // Anything else (like conclusions) remain plain text
          else {
            html += `<p class="mb-1">${opt}</p>`;
          }
        });


        card.innerHTML = html;
        questionsArea.appendChild(card);
      });
    }

    function eq(a, b) { return String(a || "").trim().toLowerCase() === String(b || "").trim().toLowerCase(); }
    async function uploadToCloudinary(blob) {
      const url = "https://api.cloudinary.com/v1_1/druxczlqv/video/upload";
      const formData = new FormData(); formData.append("file", blob); formData.append("upload_preset", "exam_videos");
      try { const resp = await fetch(url, { method: "POST", body: formData }); const data = await resp.json(); return data.secure_url; } catch (err) { console.error(err); return null; }
    }
    function showToast(message, success = true) { const toastEl = document.getElementById("submitToast"); const toastBody = document.getElementById("toastMessage"); toastBody.textContent = message; toastEl.classList.remove("text-bg-success", "text-bg-danger"); toastEl.classList.add(success ? "text-bg-success" : "text-bg-danger"); new bootstrap.Toast(toastEl).show(); }

    async function showResult(finalData, save = true) {
      document.getElementById("resName").textContent = finalData.fullname;
      document.getElementById("resSuccode").textContent = finalData.succode;
      document.getElementById("resCollege").textContent = finalData.college;
      document.getElementById("resMobile").textContent = finalData.mobile;
      document.getElementById("resEmail").textContent = finalData.email;
      document.getElementById("resCompany").textContent = finalData.company;
      document.getElementById("resMarks").textContent = finalData.marks;
      document.getElementById("resStatus").textContent = "Completed";
      document.getElementById("resExplanations").innerHTML = finalData.explanations || "";
      const reasonEl = document.getElementById("resReason");
      if (finalData.reason) { reasonEl.textContent = `Auto-submitted: ${finalData.reason}`; reasonEl.style.display = "block"; } else reasonEl.style.display = "none";
      document.getElementById("resultArea").classList.remove("d-none");
      document.getElementById("infoForm").classList.add("d-none");
      document.getElementById("examForm").classList.add("d-none");
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      if (save) { saveResult(finalData); saveCompletedCompany(finalData.company); markCompletedCompanies(); }
    }

    async function gradeExam(reason = "") {
      if (submitted) return; submitted = true;
      if (!questionsData[student.company]) return;
      if (mediaRecorder && mediaRecorder.state !== "inactive") await new Promise(resolve => { mediaRecorder.onstop = resolve; mediaRecorder.stop(); });
      const videoBlob = new Blob(recordedChunks, { type: "video/webm" });
      let correct = 0, explanationsHTML = "";
      questionsData[student.company].forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        if (selected && eq(selected.value, q.answer)) correct++;
        explanationsHTML += `<div class="card mb-2 p-2"><p><b>${q.question}</b></p><p>‚úÖ Correct Answer: ${q.answer}</p><p>‚ÑπÔ∏è Explanation: ${q.explanation}</p></div>`;
      });
      const finalData = { fullname: student.fullName, succode: student.succode, college: student.college, mobile: student.mobile, email: student.email, company: student.company, marks: `${correct} / ${questionsData[student.company].length}`, completed: "Yes", explanations: explanationsHTML, reason: reason, video: "" };
      try {
        finalData.video = await uploadToCloudinary(videoBlob);
        const resp = await fetch("https://3c1d63f2ac49.ngrok-free.app/submitExam", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(finalData) });
        const json = await resp.json();
        if (json && json.success && json.id) { finalData.id = json.id; showToast(finalData.video ? "‚úÖ Video URL sent successfully!" : "‚ö†Ô∏è No video recorded.", true); } else showToast("‚ùå Submission failed!", false);
      } catch (err) { console.error(err); showToast("‚ùå Submission failed!", false); }
      showResult(finalData, true);
    }

    document.getElementById("infoForm").addEventListener("submit", async e => {
      e.preventDefault();
      ["fullName", "succode", "college", "mobile", "email"].forEach(k => student[k] = document.getElementById(k).value);
      student.company = document.getElementById("companySelect").value;
      if (!student.company) { alert("Please select a company"); return; }
      document.getElementById("infoForm").classList.add("d-none");
      document.getElementById("examForm").classList.remove("d-none");
      renderQuestions(student.company);

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 }, audio: true });
        document.getElementById("videoPreview").srcObject = stream;
        window._mediaStreamTracks = stream.getTracks();
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.start();
      } catch (err) { console.error(err); alert("Camera/Microphone access denied. Exam cannot continue."); location.reload(); }
    });

    document.getElementById("examForm").addEventListener("submit", e => { e.preventDefault(); gradeExam(""); });
    document.addEventListener("visibilitychange", () => { if (document.hidden && !submitted) gradeExam("Tab/window change detected."); });
    document.getElementById("homeBtn").addEventListener("click", () => { if (window._mediaStreamTracks) window._mediaStreamTracks.forEach(track => track.stop()); document.getElementById("resultArea").classList.add("d-none"); document.getElementById("infoForm").classList.remove("d-none"); markCompletedCompanies(); });

    loadQuestions(); markCompletedCompanies();
  </script>
</body>

</html>