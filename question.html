<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Code Master Exam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; }
    .question-card { margin-bottom: 20px; }
    .form-title { text-align: center; margin-bottom: 30px; }
    .submit-btn { text-align: center; margin-top: 20px; }
    .result-card { margin-top: 30px; }
    #videoPreview { width: 300px; height: 220px; border: 2px solid #ccc; border-radius: 10px; margin: 10px auto; display: block; }
    .completed-item { cursor: pointer; }
    .completed-item:hover { background: #e9ecef; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="form-title">
      <h2 class="fw-bold">Code Master - Online Exam</h2>
      <p class="text-muted">Answer all questions carefully</p>
    </div>

    <!-- Student Info -->
    <form id="infoForm" autocomplete="off">
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Full Name</label>
        <input type="text" class="form-control" id="fullName" required>
      </div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Succode</label>
        <input type="text" class="form-control" id="succode" required>
      </div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">College</label>
        <input type="text" class="form-control" id="college" required>
      </div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Select Company</label>
        <select id="companySelect" class="form-select" required>
          <option value="">-- Choose Company --</option>
        </select>
      </div>
      <div class="submit-btn">
        <button type="submit" class="btn btn-primary btn-lg">Start Exam</button>
      </div>
      <div id="completedList" class="mt-4"></div>
    </form>

    <!-- Exam Form -->
    <form id="examForm" class="d-none" autocomplete="off">
      <video id="videoPreview" autoplay muted></video>
      <div id="questionsArea"></div>
      <div class="submit-btn">
        <button type="submit" class="btn btn-success btn-lg">Submit Exam</button>
      </div>
    </form>

    <!-- Results -->
    <div id="resultArea" class="result-card d-none">
      <div class="card p-4 shadow-sm">
        <h4 class="fw-bold">Exam Result</h4>
        <p class="mb-1"><b>Full Name:</b> <span id="resName"></span></p>
        <p class="mb-1"><b>Succode:</b> <span id="resSuccode"></span></p>
        <p class="mb-1"><b>Company:</b> <span id="resCompany"></span></p>
        <p class="mb-1"><b>Marks:</b> <span id="resMarks"></span></p>
        <p class="mb-1"><b>Status:</b> <span id="resStatus"></span></p>
        <p class="text-danger" id="resReason" style="display:none;"></p>
        <h5 class="mt-3">Explanations:</h5>
        <div id="resExplanations"></div>

        <h5 class="mt-3">Recording:</h5>
        <video id="recordedVideo" controls style="width:300px; border:2px solid #ccc; border-radius:10px;"></video>

        <div class="text-center mt-3">
          <button id="homeBtn" class="btn btn-secondary">üè† Home</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Firebase helpers (module) ===== -->
  <script type="module">
    // Firebase modular v10+
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, query, where, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

    // <-- use your config; storageBucket fixed to .appspot.com -->
    const firebaseConfig = {
      apiKey: "AIzaSyAMMrA8n1soETbw1p-157T5BL5_Id5aK20",
      authDomain: "codemaster-exam.firebaseapp.com",
      projectId: "codemaster-exam",
      storageBucket: "codemaster-exam.appspot.com",
      messagingSenderId: "290723721593",
      appId: "1:290723721593:web:dda7f4c2abd5d119b7bfa8"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // upload blob to storage and return download URL
    async function uploadRecording(blob, succode, company) {
      const ts = Date.now();
      const path = `recordings/${succode}_${company}_${ts}.webm`;
      const fileRef = ref(storage, path);
      await uploadBytes(fileRef, blob);
      const url = await getDownloadURL(fileRef);
      return { url, path };
    }

    // save exam result doc in Firestore
    // docId uses succode_company_ts for uniqueness
    async function saveResultFirebase(finalData) {
      const docId = `${finalData.succode}_${finalData.company}_${Date.now()}`;
      const docRef = doc(db, "examResults", docId);
      await setDoc(docRef, finalData);
      return docId;
    }

    // get a specific result by exact docId (if you saved docId earlier)
    async function getResultByDocId(docId) {
      const d = await getDoc(doc(db, "examResults", docId));
      return d.exists() ? d.data() : null;
    }

    // get any result for a succode & company (latest) - helper to show completed list if needed
    async function getLatestResultFor(succode, company) {
      // simplistic approach: fetch all and return the most recent by date field if present
      const q = query(collection(db, "examResults"), where("succode", "==", succode), where("company", "==", company));
      const snap = await getDocs(q);
      if (snap.empty) return null;
      let best = null;
      snap.forEach(docSnap => {
        const d = docSnap.data();
        if (!best || new Date(d.date) > new Date(best.date)) best = d;
      });
      return best;
    }

    // Expose to window for main script to call
    window.firebaseHelpers = {
      uploadRecording,
      saveResultFirebase,
      getLatestResultFor,
      getResultByDocId
    };
  </script>

  <!-- ===== Main exam script ===== -->
  <script>
    // ======================= Anti-cheat restrictions =======================
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("selectstart", e => e.preventDefault());
    ["copy", "paste", "cut"].forEach(evt =>
      document.addEventListener(evt, e => e.preventDefault())
    );

    document.addEventListener("keydown", e => {
      const key = e.key;
      const blockedCtrl = ["u","U","c","C","v","V","x","X","s","S"];
      if (
        key === "F12" || key === "PrintScreen" ||
        (e.ctrlKey && blockedCtrl.includes(key)) ||
        (e.ctrlKey && e.shiftKey && (key === "i" || key === "I"))
      ) {
        e.preventDefault();
        alert("‚ö†Ô∏è This action is disabled during the exam!");
      }
    });

    document.addEventListener("keyup", e => {
      if (e.key === "PrintScreen") {
        navigator.clipboard.writeText("");
        alert("‚ö†Ô∏è Screenshots are disabled during the exam!");
      }
    });

    // ======================= Exam logic =======================
    let questionsData = {};
    let submitted = false;
    let mediaRecorder;
    let recordedChunks = [];
    let student = { fullName: "", succode: "", college: "", company: "" };

    const companies = ["TCS","Infosys","Wipro","Accenture","Tech Mahindra","Cognizant","Capgemini","IBM","Oracle","HCL"];

    // ---- LocalStorage helpers (kept as backup + fast UI) ----
    function saveResultLocal(data) {
      let results = JSON.parse(localStorage.getItem("examResults") || "[]");
      results = results.filter(r => r.company !== data.company || r.succode !== data.succode);
      results.push(data);
      localStorage.setItem("examResults", JSON.stringify(results));
    }

    function getResultLocal(company, succode) {
      let results = JSON.parse(localStorage.getItem("examResults") || "[]");
      return results.find(r => r.company === company && r.succode === succode);
    }

    function saveCompletedCompanyLocal(company) {
      let completed = JSON.parse(localStorage.getItem("completedCompanies") || "[]");
      if (!completed.includes(company)) {
        completed.push(company);
        localStorage.setItem("completedCompanies", JSON.stringify(completed));
      }
    }

    function getCompletedCompaniesLocal() {
      return JSON.parse(localStorage.getItem("completedCompanies") || "[]");
    }

    // ---- UI helpers ----
    function markCompletedCompanies() {
      const completed = getCompletedCompaniesLocal();
      const listDiv = document.getElementById("completedList");
      if (completed.length > 0) {
        listDiv.innerHTML = "<h6>‚úÖ Completed Tests</h6><ul class='list-group'>" +
          completed.map(c => `<li class="list-group-item completed-item" data-company="${c}">${c} ‚úÖ</li>`).join("") +
          "</ul>";
        document.querySelectorAll(".completed-item").forEach(item => {
          item.addEventListener("click", async () => {
            const comp = item.getAttribute("data-company");
            // Try Firebase first (latest result for current succode)
            const local = getResultLocal(comp, student.succode);
            let res = null;
            try {
              if (window.firebaseHelpers && student.succode) {
                res = await window.firebaseHelpers.getLatestResultFor(student.succode, comp);
              }
            } catch (e) { console.warn("Firebase fetch failed:", e); }
            if (!res && local) res = local;
            if (res) showResult(res, false);
          });
        });
      } else listDiv.innerHTML = "";
      // remove already completed options from select
      const companySelect = document.getElementById("companySelect");
      [...companySelect.options].forEach(opt => {
        if (opt.value && completed.includes(opt.value)) opt.remove();
      });
    }

    // ---- Load questions (same parsing from question.txt) ----
    async function loadQuestions() {
      try {
        const response = await fetch("question.txt");
        const lines = (await response.text()).split("\n").map(l => l.trim());
        let currentCompany = "";
        let qObj = null;
        lines.forEach(line => {
          if (!line) return;
          if (companies.includes(line)) {
            currentCompany = line;
            if (!questionsData[currentCompany]) questionsData[currentCompany] = [];
            qObj = null;
            return;
          }
          if (line.startsWith("Q")) {
            qObj = { question: line, options: [], answer: "", explanation: "" };
            questionsData[currentCompany].push(qObj);
            return;
          }
          if (qObj && qObj.options.length < 4 && !line.startsWith("Answer:") && !line.startsWith("Explanation:")) {
            qObj.options.push(line);
            return;
          }
          if (line.startsWith("Answer:")) {
            qObj.answer = line.replace("Answer:", "").trim();
            return;
          }
          if (line.startsWith("Explanation:")) {
            qObj.explanation = line.replace("Explanation:", "").trim();
            return;
          }
        });
      } catch (e) {
        console.warn("Could not load question.txt ‚Äî make sure it's present.", e);
      }

      const completed = getCompletedCompaniesLocal();
      const companySelect = document.getElementById("companySelect");
      companies.forEach(company => {
        if (!completed.includes(company)) {
          const opt = document.createElement("option");
          opt.value = company;
          opt.textContent = company;
          companySelect.appendChild(opt);
        }
      });
    }

    // ---- Render questions ----
    function renderQuestions(company) {
      const questionsArea = document.getElementById("questionsArea");
      questionsArea.innerHTML = "";
      if (!company || !questionsData[company] || questionsData[company].length === 0) {
        questionsArea.innerHTML = `<div class="alert alert-warning">No questions available for ${company}. Updated Soon.</div>`;
        return;
      }
      questionsData[company].forEach((q, index) => {
        const card = document.createElement("div");
        card.className = "card question-card p-3 shadow-sm";
        card.innerHTML = `<h5 class="fw-bold">${q.question}</h5>` +
          q.options.map(opt => `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="q${index}" value="${opt}" required>
              <label class="form-check-label">${opt}</label>
            </div>`).join("");
        questionsArea.appendChild(card);
      });
    }

    function eq(a,b) { return String(a).trim().toLowerCase() === String(b).trim().toLowerCase(); }

    // ---- Show result (now async to allow firebase save) ----
    async function showResult(finalData, save = true) {
      document.getElementById("resName").textContent = finalData.fullname;
      document.getElementById("resSuccode").textContent = finalData.succode;
      document.getElementById("resCompany").textContent = finalData.company;
      document.getElementById("resMarks").textContent = finalData.marks;
      document.getElementById("resStatus").textContent = "Completed";
      document.getElementById("resExplanations").innerHTML = finalData.explanations || "";

      const reasonEl = document.getElementById("resReason");
      if (finalData.reason) { reasonEl.textContent = `Auto-submitted: ${finalData.reason}`; reasonEl.style.display = "block"; }
      else reasonEl.style.display = "none";

      if (finalData.recordingURL) document.getElementById("recordedVideo").src = finalData.recordingURL;
      else document.getElementById("recordedVideo").removeAttribute("src");

      document.getElementById("resultArea").classList.remove("d-none");
      document.getElementById("infoForm").classList.add("d-none");
      document.getElementById("examForm").classList.add("d-none");
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

      if (save) {
        // Save local backup
        saveResultLocal(finalData);
        saveCompletedCompanyLocal(finalData.company);
        markCompletedCompanies();

        // Save to Firebase (if helpers available)
        if (window.firebaseHelpers) {
          try {
            // If the recordingURL is a local blob URL, upload the blob to Firebase
            let finalRecordingURL = finalData.recordingURL || "";
            if (finalRecordingURL && finalRecordingURL.startsWith("blob:")) {
              // can't retrieve the blob from a blob URL; we should upload the recordedChunks directly earlier instead.
              // But in our flow, we upload blob before calling showResult ‚Äî so this is just a fallback.
              console.warn("Recording is a blob URL fallback ‚Äî upload might not have happened.");
            }
            // Save metadata doc
            const savedDocId = await window.firebaseHelpers.saveResultFirebase({
              fullname: finalData.fullname,
              succode: finalData.succode,
              college: finalData.college || "",
              company: finalData.company,
              marks: finalData.marks,
              explanations: finalData.explanations || "",
              reason: finalData.reason || "",
              recordingURL: finalData.recordingURL || "",
              date: new Date().toISOString()
            });
            // you could store savedDocId locally if needed
            console.log("Saved to Firestore doc:", savedDocId);
          } catch (e) {
            console.error("Failed writing result to Firebase:", e);
          }
        }
      }
    }

    // ---- Stop recording, upload to firebase, return permanent URL ----
    function stopRecordingAndUpload(finalData) {
      return new Promise((resolve) => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") return resolve(finalData.recordingURL || "");
        mediaRecorder.onstop = async () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          // Try uploading to Firebase via helper
          if (window.firebaseHelpers && window.firebaseHelpers.uploadRecording) {
            try {
              const { url } = await window.firebaseHelpers.uploadRecording(blob, student.succode, student.company);
              resolve(url);
            } catch (err) {
              console.error("Upload failed, falling back to blob URL:", err);
              const url = URL.createObjectURL(blob);
              resolve(url);
            }
          } else {
            // If firebase not ready, fallback to blob URL
            const url = URL.createObjectURL(blob);
            resolve(url);
          }
        };
        try { mediaRecorder.stop(); } catch (e) { resolve(finalData.recordingURL || ""); }
      });
    }

    // ---- Grade and submit ----
    async function gradeExam(reason = "") {
      if (submitted) return;
      submitted = true;
      if (!questionsData[student.company]) return;

      let correct = 0;
      let explanationsHTML = "";
      const total = questionsData[student.company].length;

      questionsData[student.company].forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        if (selected && eq(selected.value, q.answer)) correct++;
        explanationsHTML += `<div class="card mb-2 p-2">
          <p><b>${q.question}</b></p>
          <p>‚úÖ Correct Answer: ${q.answer}</p>
          <p>‚ÑπÔ∏è Explanation: ${q.explanation}</p>
        </div>`;
      });

      // Prepare final data
      let finalData = {
        fullname: student.fullName,
        succode: student.succode,
        college: student.college,
        company: student.company,
        marks: `${correct} / ${total}`,
        completed: "Yes",
        explanations: explanationsHTML,
        reason: reason || "",
        recordingURL: "" ,
        date: new Date().toISOString()
      };

      // stop recorder and upload => get permanent URL
      const recordingURL = await stopRecordingAndUpload(finalData);
      finalData.recordingURL = recordingURL || "";

      // Show result and save (both local and Firebase)
      await showResult(finalData, true);
    }

    // ---- Start exam handler ----
    document.getElementById("infoForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      student.fullName = document.getElementById("fullName").value.trim();
      student.succode = document.getElementById("succode").value.trim();
      student.college = document.getElementById("college").value.trim();
      student.company = document.getElementById("companySelect").value;
      if (!student.company) { alert("Please select a company"); return; }

      document.getElementById("infoForm").classList.add("d-none");
      document.getElementById("examForm").classList.remove("d-none");
      renderQuestions(student.company);

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("videoPreview").srcObject = stream;
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.start();
      } catch (err) {
        alert("Camera/Microphone access denied. Exam cannot continue.");
        console.error(err);
      }
    });

    // Manual submit
    document.getElementById("examForm").addEventListener("submit", function (e) {
      e.preventDefault();
      gradeExam("");
    });

    // Auto-submit on tab hide
    document.addEventListener("visibilitychange", () => {
      if (document.hidden && !submitted) gradeExam("Tab/window change detected.");
    });

    // Home button
    document.getElementById("homeBtn").addEventListener("click", () => {
      document.getElementById("resultArea").classList.add("d-none");
      document.getElementById("infoForm").classList.remove("d-none");
      document.getElementById("examForm").classList.add("d-none");
      submitted = false;
      markCompletedCompanies();
    });

    // Init
    (async function init() {
      await loadQuestions();
      markCompletedCompanies();
    })();
  </script>
</body>
</html>
