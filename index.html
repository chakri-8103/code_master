<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Code Master Exam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
    }

    .question-card {
      margin-bottom: 20px;
    }

    .form-title {
      text-align: center;
      margin-bottom: 30px;
    }

    .submit-btn {
      text-align: center;
      margin-top: 20px;
    }

    .result-card {
      margin-top: 30px;
    }

    #videoPreview {
      width: 300px;
      height: 220px;
      border: 2px solid #ccc;
      border-radius: 10px;
      margin: 10px auto;
      display: block;
    }

    .completed-item {
      cursor: pointer;
    }

    .completed-item:hover {
      background: #e9ecef;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <div class="form-title">
      <h2 class="fw-bold">Code Master - Online Exam</h2>
      <p class="text-muted">Answer all questions carefully</p>
    </div>

    <form id="infoForm" autocomplete="off">
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Full Name</label>
        <input type="text" class="form-control" id="fullName" required>
      </div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Succode</label>
        <input type="text" class="form-control" id="succode" required>
      </div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">College</label>
        <input type="text" class="form-control" id="college" required>
      </div>
      <div class="card mb-3 p-3">
        <label class="form-label fw-bold">Select Company</label>
        <select id="companySelect" class="form-select" required>
          <option value="">-- Choose Company --</option>
        </select>
      </div>
      <div class="submit-btn">
        <button type="submit" class="btn btn-primary btn-lg">Start Exam</button>
      </div>
      <div id="completedList" class="mt-4"></div>
    </form>

    <form id="examForm" class="d-none" autocomplete="off">
      <video id="videoPreview" autoplay muted></video>
      <div id="questionsArea"></div>
      <div class="submit-btn">
        <button type="submit" class="btn btn-success btn-lg">Submit Exam</button>
      </div>
    </form>

    <div id="resultArea" class="result-card d-none">
      <div class="card p-4 shadow-sm">
        <h4 class="fw-bold">Exam Result</h4>
        <p class="mb-1"><b>Full Name:</b> <span id="resName"></span></p>
        <p class="mb-1"><b>Succode:</b> <span id="resSuccode"></span></p>
        <p class="mb-1"><b>Company:</b> <span id="resCompany"></span></p>
        <p class="mb-1"><b>Marks:</b> <span id="resMarks"></span></p>
        <p class="mb-1"><b>Status:</b> <span id="resStatus"></span></p>
        <p class="text-danger" id="resReason" style="display:none;"></p>
        <h5 class="mt-3">Explanations:</h5>
        <div id="resExplanations"></div>
        <h5 class="mt-3">Recording:</h5>
        <video id="recordedVideo" controls style="width:300px; border:2px solid #ccc; border-radius:10px;"></video>
        <div class="text-center mt-3">
          <button id="homeBtn" class="btn btn-secondary">üè† Home</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Anti-cheat
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("selectstart", e => e.preventDefault());
    ["copy", "paste", "cut"].forEach(evt =>
      document.addEventListener(evt, e => e.preventDefault())
    );
    document.addEventListener("keydown", e => {
      const key = e.key;
      const blockedCtrl = ["u", "U", "c", "C", "v", "V", "x", "X", "j", "J", "s", "S"];
      if (key === "F12" || key === "PrintScreen" ||
        (e.ctrlKey && blockedCtrl.includes(key)) ||
        (e.ctrlKey && e.shiftKey && (key === "i" || key === "I"))) {
        e.preventDefault();
        alert("‚ö†Ô∏è This action is disabled during the exam!");
      }
    });
    document.addEventListener("keyup", e => {
      if (e.key === "PrintScreen") {
        navigator.clipboard.writeText("");
        alert("‚ö†Ô∏è Screenshots are disabled during the exam!");
      }
    });

    let questionsData = {};
    let submitted = false;
    let mediaRecorder;
    let recordedChunks = [];
    let student = { fullName: "", succode: "", college: "", company: "" };
    const companies = ["TCS", "Infosys", "Wipro", "Accenture", "Tech Mahindra", "Cognizant", "Capgemini", "IBM", "Oracle", "HCL"];

    function saveResult(data) {
      let results = JSON.parse(localStorage.getItem("examResults") || "[]");
      results = results.filter(r => r.company !== data.company);
      results.push(data);
      localStorage.setItem("examResults", JSON.stringify(results));
    }
    function getResult(company) {
      let results = JSON.parse(localStorage.getItem("examResults") || "[]");
      return results.find(r => r.company === company);
    }
    function saveCompletedCompany(company) {
      let completed = JSON.parse(localStorage.getItem("completedCompanies") || "[]");
      if (!completed.includes(company)) {
        completed.push(company);
        localStorage.setItem("completedCompanies", JSON.stringify(completed));
      }
    }
    function markCompletedCompanies() {
      let completed = JSON.parse(localStorage.getItem("completedCompanies") || "[]");
      const listDiv = document.getElementById("completedList");
      if (completed.length > 0) {
        listDiv.innerHTML = "<h6>‚úÖ Completed Tests</h6><ul class='list-group'>" +
          completed.map(c => `<li class="list-group-item completed-item" data-company="${c}">${c} ‚úÖ</li>`).join("") +
          "</ul>";
        document.querySelectorAll(".completed-item").forEach(item => {
          item.addEventListener("click", () => {
            const comp = item.getAttribute("data-company");
            const res = getResult(comp);
            if (res) showResult(res, false);
          });
        });
      } else listDiv.innerHTML = "";
      const companySelect = document.getElementById("companySelect");
      [...companySelect.options].forEach(opt => {
        if (completed.includes(opt.value)) opt.remove();
      });
    }

    async function loadQuestions() {
      const response = await fetch("question.txt");
      const lines = (await response.text()).split("\n").map(l => l.trim());
      let currentCompany = "", qObj = null;
      lines.forEach(line => {
        if (!line) return;
        if (companies.includes(line)) { currentCompany = line; if (!questionsData[currentCompany]) questionsData[currentCompany] = []; qObj = null; return; }
        if (line.startsWith("Q")) { qObj = { question: line, options: [], answer: "", explanation: "" }; questionsData[currentCompany].push(qObj); return; }
        if (qObj && qObj.options.length < 4 && !line.startsWith("Answer:") && !line.startsWith("Explanation:")) { qObj.options.push(line); return; }
        if (line.startsWith("Answer:")) { qObj.answer = line.replace("Answer:", "").trim(); return; }
        if (line.startsWith("Explanation:")) { qObj.explanation = line.replace("Explanation:", "").trim(); return; }
      });
      const completed = JSON.parse(localStorage.getItem("completedCompanies") || "[]");
      const companySelect = document.getElementById("companySelect");
      companies.forEach(company => {
        if (!completed.includes(company)) {
          const opt = document.createElement("option");
          opt.value = company; opt.textContent = company;
          companySelect.appendChild(opt);
        }
      });
    }

    function renderQuestions(company) {
      const questionsArea = document.getElementById("questionsArea");
      questionsArea.innerHTML = "";
      if (!company || !questionsData[company] || questionsData[company].length === 0) {
        questionsArea.innerHTML = `<div class="alert alert-warning">No questions available for ${company}. Updated Soon.</div>`;
        return;
      }
      questionsData[company].forEach((q, index) => {
        const card = document.createElement("div");
        card.className = "card question-card p-3 shadow-sm";
        card.innerHTML = `<h5 class="fw-bold">${q.question}</h5>` +
          q.options.map(opt => `<div class="form-check">
            <input class="form-check-input" type="radio" name="q${index}" value="${opt}" required>
            <label class="form-check-label">${opt}</label></div>`).join("");
        questionsArea.appendChild(card);
      });
    }

    function eq(a, b) { return String(a).trim().toLowerCase() === String(b).trim().toLowerCase(); }

    function showResult(finalData, save = true) {
      document.getElementById("resName").textContent = finalData.fullname;
      document.getElementById("resSuccode").textContent = finalData.succode;
      document.getElementById("resCompany").textContent = finalData.company;
      document.getElementById("resMarks").textContent = finalData.marks;
      document.getElementById("resStatus").textContent = "Completed";
      document.getElementById("resExplanations").innerHTML = finalData.explanations || "";
      const reasonEl = document.getElementById("resReason");
      if (finalData.reason) { reasonEl.textContent = `Auto-submitted: ${finalData.reason}`; reasonEl.style.display = "block"; } else reasonEl.style.display = "none";
      if (finalData.recordingURL) document.getElementById("recordedVideo").src = finalData.recordingURL;
      document.getElementById("resultArea").classList.remove("d-none");
      document.getElementById("infoForm").classList.add("d-none");
      document.getElementById("examForm").classList.add("d-none");
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      if (save) { saveResult(finalData); saveCompletedCompany(finalData.company); markCompletedCompanies(); }
    }

    async function stopRecordingAndGetURL() {
      return new Promise((resolve) => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") return resolve("");
        mediaRecorder.onstop = async () => {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const formData = new FormData();
          formData.append("file", blob);
          formData.append("upload_preset", "exam_videos_unsigned"); // <-- your preset
          formData.append("folder", "exam_videos"); // optional folder
          try {
            const res = await fetch("https://api.cloudinary.com/v1_1/druxczlqv/video/upload", { method: "POST", body: formData });
            const data = await res.json();
            resolve(data.secure_url || "");
          } catch (err) { console.error(err); resolve(""); }
        };
        try { mediaRecorder.stop(); } catch (e) { resolve(""); }
      });
    }

    async function gradeExam(reason = "") {
      if (submitted) return; submitted = true;
      if (!questionsData[student.company]) return;
      let correct = 0, explanationsHTML = "";
      questionsData[student.company].forEach((q, index) => {
        const selected = document.querySelector(`input[name="q${index}"]:checked`);
        if (selected && eq(selected.value, q.answer)) correct++;
        explanationsHTML += `<div class="card mb-2 p-2"><p><b>${q.question}</b></p><p>‚úÖ Correct Answer: ${q.answer}</p><p>‚ÑπÔ∏è Explanation: ${q.explanation}</p></div>`;
      });
      const recordingURL = await stopRecordingAndGetURL();
      const finalData = {
        fullname: student.fullName,
        succode: student.succode,
        company: student.company,
        marks: `${correct} / ${questionsData[student.company].length}`,
        completed: "Yes",
        explanations: explanationsHTML,
        reason: reason,
        recordingURL: recordingURL || ""
      };
      showResult(finalData, true);
    }

    document.getElementById("infoForm").addEventListener("submit", async e => {
      e.preventDefault();
      student.fullName = document.getElementById("fullName").value;
      student.succode = document.getElementById("succode").value;
      student.college = document.getElementById("college").value;
      student.company = document.getElementById("companySelect").value;
      if (!student.company) { alert("Please select a company"); return; }
      document.getElementById("infoForm").classList.add("d-none");
      document.getElementById("examForm").classList.remove("d-none");
      renderQuestions(student.company);
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("videoPreview").srcObject = stream;
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.start();
      } catch (err) { alert("Camera/Microphone access denied. Exam cannot continue."); }
    });

    document.getElementById("examForm").addEventListener("submit", e => { e.preventDefault(); gradeExam(""); });
    document.addEventListener("visibilitychange", () => { if (document.hidden && !submitted) gradeExam("Tab/window change detected."); });
    document.getElementById("homeBtn").addEventListener("click", () => {
      document.getElementById("resultArea").classList.add("d-none");
      document.getElementById("infoForm").classList.remove("d-none");
      document.getElementById("examForm").classList.add("d-none");
      submitted = false; markCompletedCompanies();
    });

    loadQuestions(); markCompletedCompanies();
  </script>
</body>

</html>